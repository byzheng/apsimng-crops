---
title: "{{title}}"
format: html
params:
  crop: "{{crop}}"
  cultivar: "{{cultivar}}"
has_data: true
---


```{r setup, echo=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, error = FALSE, message = FALSE)

if (!exists("params") || grepl("\\{", params$crop)) {
    crop <- "Wheat"
    cultivar <- "Yitpi"
} else {
    crop <- params[["crop"]]
    cultivar <- params[["cultivar"]]
}
crop_data_dir <- "_data/_outputs"

```

```{r data-obs-sim}

# Read the obs/prediction files
file_path <- file.path(crop_data_dir, paste0(crop, ".Rds")) |> 
    here::here()
message("Reading cached output: ", file_path)
obs_sim <- readRDS(file_path)

model <- sprintf("https://raw.githubusercontent.com/APSIMInitiative/ApsimX/refs/heads/master/Models/Resources/%s.json", crop)

apsimx <- rapsimng::read_apsimx(model)
cultivars <- rapsimng::get_cultivar(apsimx, alias = TRUE) |> tibble::tibble()
cultivar_info <- cultivars |> dplyr::filter(standard_name == cultivar)
```


This report is generated for performance of `r crop` model in APSIM NG for cultivar `r cultivar`. 


## Cultivar Information


The cultivar specific parameters used in the simulation are listed in the table below:

```{r tbl-cultivar_info}
cultivar_info |> 
    dplyr::select(-name) |> 
    dplyr::distinct() |>
    dplyr::select(parameter, value) |>
    knitr::kable(caption = sprintf("Cultivar specific parameters for `%s`", cultivar))

```

```{r cultivar_aliases,results='asis'}

aliases <- cultivar_info |> 
    dplyr::distinct(name) |> 
    dplyr::filter(name != cultivar) |> 
    dplyr::pull(name)
if (length(aliases) > 0) {
    #cat("\n")
    cat("The following aliases are also available for this cultivar: **")
    aliases |>
        paste(collapse = ", ") |>
        cat()
    cat("**")
    #cat("\n")
}
```

## Experiments


::: {.content-hidden when-meta="has_data"}
> No observations available for this cultivar.
:::



::: {.content-visible when-meta="has_data"}



```{r data-obs-sim-cultivar}

obs_sim_cultivar <- obs_sim |> 
    dplyr::filter(Genotype == tolower(cultivar)) |> 
    dplyr::mutate(trait = gsub(paste0("^", crop, "\\."), "", trait))

experiments <- obs_sim_cultivar |> 
    dplyr::distinct(ExperimentName, Latitude, Longitude)
```

There are `r nrow(experiments)` experiments which tested cultivar `r cultivar` and its aliases.


```{r fig-experiments, fig.height=6, fig.cap="Locations of experiments without controlled environments."}
experiments |> 
    dplyr::filter(!is.na(Longitude), !is.na(Latitude)) |>
    dplyr::filter(Longitude != 0 & Latitude != 0) |>
    leaflet::leaflet(options = leaflet::leafletOptions(scrollWheelZoom = FALSE)) |>
    leaflet::addTiles() |>
    leaflet::addMarkers(~Longitude, ~Latitude, 
        popup = ~ExperimentName)
```

## Performance

```{r data-trait}
traits <- obs_sim_cultivar |> 
    dplyr::distinct(trait) |> 
    dplyr::pull(trait) |> 
    sort()
```


The table below summarizes the performance of APSIM NG for cultivar `r cultivar` across all experiments.

```{r tbl-performance-summary}

obs_sim_cultivar |> 
    dplyr::group_by(trait) |>
    myutils::model_summarise(x = "Observed", y = "Predicted", digits = 2)|>
    dplyr::ungroup() |>
    dplyr::arrange(trait) |>
    knitr::kable(caption = sprintf("Performance summary for cultivar `%s`", cultivar))
```

::: {.panel-tabset}

```{r performance, results = "asis", fig.cap = "Observed vs Predicted plots for different traits."}
i <- 1
for (i in seq(along = traits)) {
    trait_i <- traits[i]
    cat("### ", trait_i, "\n\n")
    
    obs_sim_trait <- obs_sim_cultivar |> 
        dplyr::filter(trait == trait_i)
    
    p <- obs_sim_trait |> 
        ggplot2::ggplot() +
        ggplot2::geom_point(ggplot2::aes(x = Observed, y = Predicted)) +
        ggplot2::theme_bw() +
        ggplot2::geom_abline() +
        ggplot2::labs(
            x = "Observed",
            y = "Predicted"
        )
    print(p)    
    cat("\n\n")
}
```

:::

:::

